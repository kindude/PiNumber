<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pi Music - Mobile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #fff;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 20px;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
        }
        
        button {
            width: 100%;
            padding: 20px;
            font-size: 1.3em;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        .start-btn {
            background: #4CAF50;
            color: white;
        }
        
        .stop-btn {
            background: #f44336;
            color: white;
        }
        
        .piano {
            display: flex;
            gap: 5px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .key {
            flex: 1;
            min-width: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px 5px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .key.active {
            background: #4CAF50;
            transform: scale(1.1);
            box-shadow: 0 0 20px #4CAF50;
        }
        
        .digits {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 1.1em;
            letter-spacing: 3px;
            word-break: break-all;
        }
        
        .digit {
            display: inline;
            transition: all 0.3s;
        }
        
        .digit.playing {
            color: #FFE66D;
            font-size: 1.5em;
        }
        
        .controls {
            margin: 20px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        select {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border-radius: 8px;
            border: none;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        
        select option {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Pi Music ü•ß</h1>
        
        <div class="status" id="status">
            Tap START to begin
        </div>
        
        <div class="controls">
            <label>Speed:</label>
            <select id="speed">
                <option value="100">Very Fast</option>
                <option value="200" selected>Fast</option>
                <option value="300">Normal</option>
                <option value="500">Slow</option>
            </select>
            
            <label>Instrument:</label>
            <select id="instrument">
                <option value="sine" selected>Simple Tone</option>
                <option value="triangle">Triangle</option>
                <option value="square">Square</option>
            </select>
        </div>
        
        <button class="start-btn" id="startBtn" onclick="start()">
            üîä TAP TO START AUDIO
        </button>
        
        <button class="stop-btn" id="stopBtn" onclick="stop()" style="display: none;">
            ‚èπÔ∏è STOP
        </button>
        
        <div class="piano" id="piano"></div>
        
        <div class="digits" id="digits"></div>
    </div>

    <script>
        const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5', 'E5'];
        let synth = null;
        let piDigits = '';
        let position = 0;
        let isPlaying = false;
        let interval = null;
        
        // Initialize piano keys
        function initPiano() {
            const piano = document.getElementById('piano');
            piano.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const key = document.createElement('div');
                key.className = 'key';
                key.id = `key${i}`;
                key.textContent = i;
                piano.appendChild(key);
            }
        }
        
        // Fetch Pi
        async function fetchPi(start, count) {
            const response = await fetch(`https://api.pi.delivery/v1/pi?start=${start}&numberOfDigits=${count}`);
            const data = await response.json();
            return data.content;
        }
        
        // Update status
        function setStatus(msg) {
            document.getElementById('status').textContent = msg;
        }
        
        // Play note
        function playNote(digit) {
            if (!synth) return;
            
            const note = notes[parseInt(digit)];
            const duration = parseInt(document.getElementById('speed').value) / 1000;
            
            try {
                synth.triggerAttackRelease(note, `${duration}s`);
                
                // Highlight key
                document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
                document.getElementById(`key${digit}`).classList.add('active');
                
                // Highlight digit
                document.querySelectorAll('.digit').forEach(d => d.classList.remove('playing'));
                const digitEls = document.querySelectorAll('.digit');
                if (digitEls[position]) {
                    digitEls[position].classList.add('playing');
                }
            } catch (error) {
                console.error('Play error:', error);
            }
        }
        
        // Start
        async function start() {
            setStatus('üîä Initializing audio...');
            
            try {
                // CRITICAL: Start audio context
                await Tone.start();
                console.log('Audio context started');
                
                // Create synth
                const type = document.getElementById('instrument').value;
                synth = new Tone.Synth({
                    oscillator: { type: type },
                    envelope: {
                        attack: 0.01,
                        decay: 0.1,
                        sustain: 0.3,
                        release: 0.2
                    }
                }).toDestination();
                
                // Set volume
                synth.volume.value = -10;
                
                console.log('Synth created');
                
                // Test sound
                setStatus('üéµ Testing audio...');
                synth.triggerAttackRelease('C4', '0.1');
                
                await new Promise(resolve => setTimeout(resolve, 200));
                
                setStatus('üì• Fetching Pi...');
                
                // Fetch initial digits
                piDigits = await fetchPi(0, 1000);
                
                // Display digits
                const digitsDiv = document.getElementById('digits');
                digitsDiv.innerHTML = '';
                for (const digit of piDigits) {
                    const span = document.createElement('span');
                    span.className = 'digit';
                    span.textContent = digit;
                    digitsDiv.appendChild(span);
                }
                
                position = 0;
                isPlaying = true;
                
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                
                setStatus('üéµ Playing Pi!');
                
                // Start playing
                const speed = parseInt(document.getElementById('speed').value);
                interval = setInterval(() => {
                    if (position >= piDigits.length) {
                        stop();
                        return;
                    }
                    
                    const digit = piDigits[position];
                    setStatus(`üéµ Playing: ${digit} ‚Üí ${notes[parseInt(digit)]}`);
                    playNote(digit);
                    position++;
                }, speed);
                
            } catch (error) {
                console.error('Error:', error);
                setStatus('‚ùå Error: ' + error.message);
                alert('Audio failed to start. Please:\n1. Turn up volume\n2. Unmute phone\n3. Try again');
            }
        }
        
        // Stop
        function stop() {
            isPlaying = false;
            if (interval) clearInterval(interval);
            
            document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
            document.querySelectorAll('.digit').forEach(d => d.classList.remove('playing'));
            
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            
            setStatus('Stopped. Tap START to play again.');
        }
        
        // Initialize on load
        window.onload = () => {
            initPiano();
            console.log('Ready! Tap START button.');
        };
    </script>
</body>
</html>